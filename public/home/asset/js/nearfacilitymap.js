var MyPoi=function(c,a,d,b,e){this.poiIndex=c;this.point=a;this.title=d;this.address=b;this.distance=e;this.id="_"+a.lat+"_"+a.lng;};nearFacilityMap={_map:null,_localSearch:null,_bounds:null,gardenPoint:null,mapDiv:"mapDiv",showDataDiv:"msl",pageSize:10,zoom:15,curZoom:15,distance:1000,initPanoramaed:false,_panorama:null,lines:null,linesTransitRoute:null,currDrawLineOnMap:null,startSearchFlag:false,endSearchFlag:true,loadingDiv:'<p class="map-surrounding-loading" >'+'<img src="'+base+'/images/frontend/loading-map.gif" width="32" height="32">'+"<span>努力加载中...</span>"+"</p>",noResultDiv:'<div class="no-data-wrap">'+'<i class="icons-qdoll icons-qdoll-empty ie6_pngbg"></i>'+'<div class="no-data-txt">'+'<p class="no-data-titsml">对不起，暂无数据</p>'+"</div>"+"</div>",init:function(){$(".lf-keyword").placeholder();if(longitude&&latitude&&longitude>0&&latitude>0){nearFacilityMap.gardenPoint=new BMap.Point(longitude,latitude);}if(!nearFacilityMap.gardenPoint){return;}nearFacilityMap.loadBaiMap();$("#mapFuncsTbs").on("click","a",function(){$(this).addClass("cur").siblings().removeClass("cur");nearFacilityMap.searchPOI();if($("#panromaTab").hasClass("cur")){$("#mapPoiTab").click();}nearFacilityMap.addAccessRecord("searchPOI");});nearFacilityMap.searchPOI();},loadBaiMap:function(){_map=new BMap.Map(nearFacilityMap.mapDiv,{enableMapClick:false});if(typeof(houseCompare)=="undefined"||!houseCompare){_map.disableScrollWheelZoom();}nearFacilityMap._map=_map;if(nearFacilityMap.gardenPoint){_map.centerAndZoom(nearFacilityMap.gardenPoint,nearFacilityMap.zoom);}else{_map.centerAndZoom(city,nearFacilityMap.zoom);}_localSearch=new BMap.LocalSearch(_map,{pageCapacity:nearFacilityMap.pageSize,onSearchComplete:nearFacilityMap.baiduSearchCompleteCallback});nearFacilityMap.initZoom();_map.addEventListener("zoomend",function(a){nearFacilityMap.curZoom=_map.getZoom();});},initZoom:function(){$("#map-side-btns").find(".zoom-in-out ").removeClass("zoom-dis");_map.addEventListener("zoomend",function(){var a=_map.getZoom();$("#map-side-btns").find(".zoom-in-out").removeClass("zoom-dis");if(a==3){$("#map-side-btns").find('.zoom-in-out[type="smaller"]').addClass("zoom-dis");}else{if(a==19){$("#map-side-btns").find('.zoom-in-out[type="bigger"]').addClass("zoom-dis");}}});if(nearFacilityMap.initZoomed){return;}$("#map-side-btns").on("click",".zoom-in-out",function(){var c=null;var b=nearFacilityMap._map.getZoom();var a=$(this).attr("type");if(a=="bigger"){b++;}else{b--;}nearFacilityMap._map.setZoom(b);});nearFacilityMap.initZoomed=true;},initPanorama:function(){$("#panromaTab").bind("click",function(){$("#mapPoiBox").hide();$(this).addClass("cur").siblings().removeClass("cur");nearFacilityMap.showPanorama();$("#panoramaBox").show();});$("#mapPoiTab").bind("click",function(){$("#panoramaBox").hide();$("#mapPoiBox").show();$(this).addClass("cur").siblings().removeClass("cur");nearFacilityMap.loadBaiMap();nearFacilityMap.searchPOI();});nearFacilityMap.showPanorama();nearFacilityMap.initFulleScreen();},initFulleScreen:function(){var e=false;var f=false;var c=false;$("body").on("click",".full-screen-btn",function(){var h=$("#switchMap b.cur");g(h);if($(this).hasClass("default-screen-btn")){$(".full-screen-btn").removeClass("default-screen-btn");f=false;nearFacilityMap.fullScreen=false;a();}else{$(".full-screen-btn").addClass("default-screen-btn");f=true;nearFacilityMap.fullScreen=true;b();nearFacilityMap.addAccessRecord("fullscreen");}});$("#fullScreenMapClose").on("click",function(){var h=$("#switchMap b.cur");g(h);f=false;nearFacilityMap.fullScreen=false;a();});function g(i){var h=i.data("type");if(h=="panoramic-map"){c=true;}else{c=false;}}$("body").on("click",".check-the-route",function(){$(".map-surrounding-label p:last").addClass("cur").siblings().removeClass("cur");$("#panoramaBox").hide();$("#mapPoiBox").show();b();});function b(){$("#fullScreenMapWrap").append($("#miniMap"));d("fullScreenMap",true,c);$.qfangDialog.DialogShow("fullScreenMap");$("#miniMap").appendTo($("#fullScreenMapWrap"));$("#msb").append($("#mapFuncsTbs"));$(".js-control").hide();f=true;nearFacilityMap.fullScreen=true;nearFacilityMap.loadBaiMap();if($(".map-surrounding-label p.cur").html()=="查路线"){var i=$("#switchMap b:first");var h=$('[data-type="full-screen"]');i.addClass("cur").siblings().removeClass("cur");g(i);h.addClass("default-screen-btn");$("#msl").addClass("dn");$("#msc").removeClass("dn");$("#mapFuncsTbs").addClass("dn");nearFacilityMap.drawLine();setTimeout(function(){nearFacilityMap.showGardenOverlay();},500);}else{$("#msl").removeClass("dn");$("#msc").addClass("dn");$("#mapFuncsTbs").removeClass("dn");nearFacilityMap.searchPOI();}nearFacilityMap.addAccessRecord("fullscreen");}function a(){$(".js-control").show().append($("#mapFuncsTbs").removeClass("dn"));$("#surroundingMap").append($("#miniMap"));$('[data-type="full-screen"]').removeClass("default-screen-btn");d("fullScreenMap",false,c);$.qfangDialog.DialogClose("fullScreenMap");$("html, body").animate({scrollTop:$("#scrollto-3").offset().top-$("#anchorNav").outerHeight()},1);$("#miniMap").appendTo($("#mapWapper"));$(".map-surrounding-label p:last").removeClass("cur").siblings().addClass("cur");$("#msl").removeClass("dn");$("#msc").addClass("dn");nearFacilityMap.loadBaiMap();nearFacilityMap.searchPOI();nearFacilityMap._map.setZoom(nearFacilityMap.curZoom);}$(window).on("resize",function(){if(!e&&$('[data-type="full-screen"]').hasClass("default-screen-btn")){e=true;setTimeout(function(){d("fullScreenMap",true,c);e=false;},100);}});function d(j,h,i){$("#"+j).css({"width":$(window).width()-200,"height":$(window).height()-200});if(h){if(i){$("#msb,#mapDiv").css({"width":$(window).width()-200-$("#mss").outerWidth()});}else{$("#msb,#mapDiv").css({"width":$(window).width()-200-$("#mss").outerWidth()});}$("#msb,#mapDiv,#panorama, #panoramaBox").css({"height":$(window).height()-200-85});$("#mss").css({"height":$(window).height()-200-85-2});$("#msl").css({"height":$(window).height()-200-85-2-39});$("#resultsList > div").css({"height":$(window).height()-200-85-39-59-91-15-2});$(".course-history").css({"height":$(window).height()-200-85-39-59-91-10-2});$(".js-course-steps").css({"height":$(window).height()-200-85-39-67-2});$("#"+j).css({"top":($(window).height()-$("#"+j).height())/2,"left":($(window).width()-$("#"+j).width())/2});}else{if(i){$("#msb").css({"width":"463"});}else{if(typeof(pageStyle)!="undefined"&&pageStyle=="new"){$("#msb,#mapDiv").css({"width":463});}else{$("#msb,#mapDiv").css({"width":688});}}$("#msb,#mapDiv, #panorama, #panoramaBox").css({"height":370});$("#mss").css({"height":370-2});$("#msl").css({"height":370-2});$("#resultsList > div, .course-history").css({"height":370-39-59-91-15-2});$(".course-history").css({"height":370-39-59-91-10-2});$(".js-course-steps").css({"height":370-39-67-2});}}},showPanorama:function(){if(nearFacilityMap.initPanoramaed){return;}var a=new BMap.PanoramaService();a.getPanoramaByLocation(nearFacilityMap.gardenPoint,function(c){var b="";if(c==null){$("#panromaTab").hide();$("#panoramaBox").hide();return;}nearFacilityMap._panorama=new BMap.Panorama("panorama");nearFacilityMap._panorama.setPosition(nearFacilityMap.gardenPoint);nearFacilityMap._panorama.disableScrollWheelZoom();});nearFacilityMap.initPanoramaed=true;},searchPOI:function(){nearFacilityMap.clearResult();nearFacilityMap.showGardenOverlay();nearFacilityMap.showCircleOverlay(true);nearFacilityMap.loading();nearFacilityMap.searchInBounds();},searchLine:function(){nearFacilityMap.clearResult();nearFacilityMap.showGardenOverlay();},drawLine:function(){if(nearFacilityMap.startSearchFlag&&nearFacilityMap.endSearchFlag){var c=$("#start").val();var b=$("#end").val();var a=$("#courseChoose p.cur").attr("data-type");$("#map_search_loading").removeClass("dn");if(a=="bus"){nearFacilityMap.getTransitRouteLines(c,b);}else{if(a=="walking"){nearFacilityMap.getWalkingRouteLines(c,b);}else{if(a=="driving"){nearFacilityMap.getDrivingRouteLines(c,b);}}}}},searchInBounds:function(){var a=ctx+"/garden/ipoi/"+gardenId;var b={types:$("#mapFuncsTbs a[class='cur']").attr("types"),distance:nearFacilityMap.distance};$.ajax({url:a,type:"POST",dataType:"JSON",data:b,success:nearFacilityMap.qfangSearchCompleteCallback,error:function(e){var c=new Array();var d=$("#mapFuncsTbs a[class='cur']").attr("keyText");if(d){c=d.split(",");}_localSearch.searchInBounds(c,_bounds);}});},barduSearchInBounds:function(){var a=new Array();var b=$("#mapFuncsTbs a[class='cur']").attr("keyText");if(b){a=b.split(",");}_localSearch.searchInBounds(a,_bounds);},getKeyword:function(a){var b={"BUS":"公交站","METRO":"地铁站","HOSPITAL":"医院","PHARMACY":"药店","FACTORY":"工厂","GAS_STATION":"加油站","AIRPORT":"飞机场","CEMETERY":"墓地陵园","PARK":"公园","SUPERMARKET":"超市","MALL":"商场","CONVENIENCE_STORE":"便利店","ATM":"ATM","BANK":"银行","RESTAURANT":"餐馆","HOTEL":"酒店","KTV":"KTV","CAFE":"咖啡厅","KINDERGARTEN":"幼儿园","PRIMARY_SCHOOL":"小学","JUNIOR_SCHOOL":"初中","MIDDLE_SCHOOL":"高中","UNIVERSITY":"大学","SPECIAL_SCHOOL":"特殊学校"};return b[a];},qfangSearchCompleteCallback:function(e){if(e&&e.ret=="1"){nearFacilityMap.clearPoiData();var l=0;for(var j in e){var h=nearFacilityMap.getKeyword(j);var g=new Array();for(var f=0;f<e[j].length;f++){if(f>=10){break;}var c=e[j][f];var m=new BMap.Point(c.lng,c.lat);var a=Math.floor(_map.getDistance(nearFacilityMap.gardenPoint,m),0);if(a>nearFacilityMap.distance){continue;}var b=new MyPoi(0,m,c.name,c.address,a);g.push(b);}if(g.length>0){g.sort(function(k,i){return k.distance-i.distance;});for(var d=0;d<g.length;d++){l++;g[d].id=l+g[d].id;g[d].poiIndex=l;}nearFacilityMap.showPoiOverlay(g);nearFacilityMap.showPoiData(h,g);}}if(l==0){nearFacilityMap.barduSearchInBounds();}}else{nearFacilityMap.barduSearchInBounds();}nearFacilityMap._map.setZoom(nearFacilityMap.curZoom);},baiduSearchCompleteCallback:function(g){if(_localSearch.getStatus()!=BMAP_STATUS_SUCCESS){nearFacilityMap.noResult();return;}if(g&&g.length>0){nearFacilityMap.clearPoiData();var m=0;for(var f=0;f<g.length;f++){var l=g[f].keyword;var h=new Array();for(var e=0;e<g[f].getCurrentNumPois();e++){var c=g[f].getPoi(e);var a=Math.floor(_map.getDistance(nearFacilityMap.gardenPoint,c.point),0);if(a>nearFacilityMap.distance){continue;}var b=new MyPoi(0,c.point,c.title,c.address,a);h.push(b);}h.sort(function(j,i){return j.distance-i.distance;});if(h.length>0){for(var d=0;d<h.length;d++){m++;h[d].id=m+h[d].id;h[d].poiIndex=m;}nearFacilityMap.showPoiOverlay(h);nearFacilityMap.showPoiData(l,h);}}if(m==0){nearFacilityMap.noResult();}}else{nearFacilityMap.noResult();}},showPoiOverlay:function(d){if(d&&d.length>0){for(var b=0;b<d.length;b++){var e=d[b];var c='<div class="crt-coordinates" data-myId="coordinates'+e.id+'" divType="poiMarker" onclick="nearFacilityMap.clickPoiOverlay(this)"><span class="data">'+e.poiIndex+'</span><i class="shadow"></i></div>';var a=new BMapLib.RichMarker(c,e.point);_map.addOverlay(a);}$("#mapDiv").find('div[divType="poiMarker"]').parent().css("background","none");}},showPoiData:function(a,c){if(a&&c&&c.length>0){var e='<div class="map-funcs-item clearfix">'+'<p class="title-big">'+a+"</p>";for(var b=0;b<c.length;b++){var d=c[b];e+='<div class="map-funcs-item-con clearfix" data-id="'+d.id+'" id="mfic'+d.id+'" onclick="nearFacilityMap.clickPoiData(this)">';e+='<i class="map-funcs-snumber fl">'+d.poiIndex+"</i>";e+='<div class="map-funcs-con fl">';e+='<p class="map-funcs-con-header clearfix">';e+='<span class="title fl">'+d.title+"</span>";e+='<span class="distance fr">'+d.distance+"米</span>";e+="</p>";e+='<p class="map-funcs-con-main">'+d.address+"</p>";e+="</div>";e+="</div>";}e+="</div>";$("#"+nearFacilityMap.showDataDiv).append(e);}},clickPoiData:function(c){if(!$(c).hasClass("mfic-active")){$(c).addClass("mfic-active").siblings().removeClass("mfic-active").parent().siblings().find(".map-funcs-item-con").removeClass("mfic-active");var a="coordinates"+$(c).attr("data-id");$("#mapDiv").find("div .crt-coordinates-active").removeClass("crt-coordinates-active");$("#mapDiv").find('div[data-myId="'+a+'"]').addClass("crt-coordinates-active");$("#mapDiv").find('div[divType="poiMarker"]').parent().css("z-index","0");$("#mapDiv").find('div[data-myId="'+a+'"]').parent().css("z-index","1");if(nearFacilityMap.curZoom>nearFacilityMap.zoom){var d=$(c).attr("data-id").split("_");var b=new BMap.Point(d[2],d[1]);nearFacilityMap._map.setCenter(b);}}},clickPoiOverlay:function(b){$("#mapDiv").find("div .crt-coordinates-active").removeClass("crt-coordinates-active");$(b).addClass("crt-coordinates-active");$("#mapDiv").find('div[divType="poiMarker"]').parent().css("z-index","0");$(b).parent().css("z-index","1");var a=$(b).attr("data-myId").replace("coordinates","");$("#msl").find('div[data-id="'+a+'"]').addClass("mfic-active").siblings().removeClass("mfic-active").parent().siblings().find(".map-funcs-item-con").removeClass("mfic-active");nearFacilityMap.checkVisible(a);},checkVisible:function(e){var d=0;var a=380;var h=$("#msl").find('div[data-id="'+e+'"]');var c=$("#msl").scrollTop();var g=h.offset().top+c-$("#msl").offset().top;var b=c>g;var f=a+c<g+h.outerHeight(true);if(f){d=g+h.outerHeight(true)-a;$("#msl").animate({scrollTop:d});}else{if(b){d=g;$("#msl").animate({scrollTop:d});}}},showGardenOverlay:function(){if(nearFacilityMap.gardenPoint&&gardenName){var a='<p class="crt-building" style="position:absolute; left:-35px; top:-10px;">'+gardenName+'<i class="arrow"></i></p>';var b=new BMapLib.RichMarker(a,nearFacilityMap.gardenPoint);_map.addOverlay(b);}},showCircleOverlay:function(a){var d=new BMap.Circle(nearFacilityMap.gardenPoint,nearFacilityMap.distance,{strokeWeight:2,fillOpacity:0.3,strokeOpacity:0.3});var c={position:new BMap.Point(nearFacilityMap.gardenPoint.lng,parseFloat(nearFacilityMap.gardenPoint.lat)+0.0093)};var b=new BMap.Label("1km",c);b.setStyle({color:"green",fontSize:"12px",height:"20px",width:"30px",textAlign:"center",lineHeight:"20px",border:"1px solid green",fontFamily:"微软雅黑"});if(a){_map.addOverlay(d);_map.addOverlay(b);}_bounds=nearFacilityMap.getSquareBounds(d.getCenter(),d.getRadius());},loading:function(){$("#"+nearFacilityMap.showDataDiv).html(nearFacilityMap.loadingDiv);},clearResult:function(){_map.clearOverlays();_map.setZoom(nearFacilityMap.curZoom);nearFacilityMap.clearPoiData();},clearPoiData:function(){$("#"+nearFacilityMap.showDataDiv).empty();},noResult:function(){$("#"+nearFacilityMap.showDataDiv).html(nearFacilityMap.noResultDiv);},getSquareBounds:function(g,b){var k=Math.sqrt(2)*b;var i=nearFacilityMap.getMecator(g);var e=i.x,m=i.y;var d=e+k/2,j=m+k/2;var c=e-k/2,h=m-k/2;var f=nearFacilityMap.getPoi(new BMap.Pixel(d,j)),l=nearFacilityMap.getPoi(new BMap.Pixel(c,h));return new BMap.Bounds(l,f);},getMecator:function(a){return _map.getMapType().getProjection().lngLatToPoint(a);},getPoi:function(a){return _map.getMapType().getProjection().pointToLngLat(a);},getKeywords:function(a){var b={onSearchComplete:function(g){if(c.getStatus()==BMAP_STATUS_SUCCESS){var h="";var f=[];if($("#"+a).val()!=""){for(var e=0;e<g.getCurrentNumPois();e++){var l=g.getPoi(e).title;if(g.getPoi(e).type==BMAP_POI_TYPE_SUBSTOP){l+="地铁站";}else{if(g.getPoi(e).type==BMAP_POI_TYPE_BUSSTOP){l+="公交站";}}var k=false;for(var d=0;d<f.length;d++){if(f[d]==l.toUpperCase()){k=true;break;}}if(k){continue;}f.push(l.toUpperCase());h+=('<p key="item" lng='+g.getPoi(e).point.lng+" lat="+g.getPoi(e).point.lat+' class="item clearfix"><i></i><span>'+l+"</span></p>");if(e>=5){break;}}}$("#map_search_keyword_results").html(h);$("#map_search_keyword_results").removeClass("dn");$("#map_search_keyword_results").find("p[key=item]").on("click",function(){if(a=="start"){nearFacilityMap.startSearchFlag=true;}else{nearFacilityMap.endSearchFlag=true;}$("#"+a).val(($(this).find("span").html()));$("#"+a).attr("lng",$(this).attr("lng"));$("#"+a).attr("lat",$(this).attr("lat"));nearFacilityMap.getRouteLines();nearFacilityMap.setHistoryKeywords();});}else{$("#map_search_keyword_results").html('<p class="item clearfix"><i></i><span>没有相关结果</span></p>');}}};$("#map_search_keyword_results").removeClass("dn");$("#map_search_condition_tips").addClass("dn");$("#map_search_noresult").addClass("dn");$("#map_search_keyword_results").html('<p class="item clearfix"><i></i><span>加载中...</span></p>');var c=new BMap.LocalSearch(_map,b);c.setPageCapacity(10);c.search($("#"+a).val());},getHistoryKeywords:function(j){var e="MAP_SEARCH_KEYWORD_HISTORYS";var a=$.cookie(e);if(a){var c="";var k=a.split("#");for(var b=0;b<k.length;b++){var g=k[b].split("|||");var f=null;var d=null;if(g[1]&&g[1]!=""){var h=g[1].split(",");f=h[0];d=h[1];}c+='<p key="item" lng='+f+" lat="+d+' class="item clearfix"><i></i><span>'+g[0]+"</span></p>";}c+='<p class="clear"><span key="clear">清空历史记录</span></p>';$("#map_search_keyword_historys").html(c);$("#map_search_keyword_historys").find("p[key=item]").on("click",function(){if(j=="start"){nearFacilityMap.startSearchFlag=true;}else{nearFacilityMap.endSearchFlag=true;}$("#"+j).val($(this).find("span").html());$("#"+j).siblings(".lf-label").hide();$("#map_search_keyword_historys").addClass("dn");$("#"+j).attr("lng",$(this).attr("lng"));$("#"+j).attr("lat",$(this).attr("lat"));nearFacilityMap.getRouteLines();nearFacilityMap.setHistoryKeywords();});$("#map_search_keyword_historys p").find("span[key=clear]").on("click",function(){nearFacilityMap.removeHistoryKeywords();$("#map_search_keyword_historys").html("");$("#map_search_keyword_historys").addClass("dn");});}else{$("#map_search_keyword_historys").addClass("dn");}},setHistoryKeywords:function(){var b=$("#start").val();var e=$("#end").val();if(b==""||e==""){return;}var m=null,k=null,d=null,a=null;if($("#start").attr("lng")){m=$("#start").attr("lng");}if($("#start").attr("lat")){k=$("#start").attr("lat");}if($("#end").attr("lng")){d=$("#end").attr("lng");}if($("#end").attr("lat")){a=$("#end").attr("lat");}var n="MAP_SEARCH_KEYWORD_HISTORYS";var c=$.cookie(n);if(c){c=((b+"|||"+m+","+k)+"#"+(e+"|||"+d+","+a)+"#"+c);var p=c.split("#");var o=[];var h=0;for(var g=0;g<p.length;g++){var l=false;for(var f=0;f<o.length;f++){if(o[f].split("|||")[0]==p[g].split("|||")[0]){l=true;break;}}if(!l){o.push(p[g]);h++;if(h>=6){break;}}}c=o.join("#");}else{c=(b+"|||"+m+","+k)+"#"+(e+"|||"+d+","+a);}var q={expires:60*60*24*360,path:"/"};$.cookie(n,c,q);},removeHistoryKeywords:function(){var c="MAP_SEARCH_KEYWORD_HISTORYS";var b=$.cookie(c);var a={expires:60*60*24*360,path:"/"};$.cookie(c,"",a);},getRouteLines:function(){nearFacilityMap.searchLine();nearFacilityMap.drawLine();},getDrivingRouteLines:function(g,a){var e=this;if(g==null||a==null||g==""||a==""){$("#map_search_condition_tips").removeClass("dn");$("#map_search_keyword_results").addClass("dn");return;}else{$("#map_search_condition_tips").addClass("dn");}var d=null;var b=null;drivingRoute=new BMap.DrivingRoute(_map,{renderOptions:{map:_map},onSearchComplete:function(h){if(!e.lines){e.lines=[];}if(drivingRoute.getStatus()==BMAP_STATUS_SUCCESS){if(h.getNumPlans()<=0){$("#map_search_loading").addClass("dn");$("#map_search_noresult").removeClass("dn");return;}var j="";for(var i=0;i<h.getNumPlans();i++){var l=h.getPlan(i);var k={};k.plan=l;k.start=g;k.end=a;k.startPoint=h.getStart();k.endPoint=h.getEnd();k.duration=l.getDuration();k.distance=l.getDistance();e.lines[i]=k;j+='<li key="item" index="'+i+'" '+(i==0?' class="cur">':"");j+='<p class="top clearfix">';j+="<span>"+l.getDuration()+"</span>";j+='<em class="divider"></em>';j+="<span>"+l.getDistance()+"</span>";j+="</p>";j+="</li>";}e.drawDrivingRoute(e.lines[0]);$("#map_search_keyword_results").addClass("dn");$("#map_search_condition_results_driving").removeClass("dn");$("#map_search_condition_results_driving").html("<ul>"+j+"</ul>");$("#map_search_condition_results_driving").find("li[key=item]").on("click",function(){var m=$(this).attr("index");$(this).addClass("cur").siblings().removeClass("cur");nearFacilityMap.getDrivingRoutePlan(e.lines[m],_map.getZoom(),_map.getCenter());});}$("#map_search_loading").addClass("dn");},onPolylinesSet:function(h){drivingRoute.clearResults();}});var c=nearFacilityMap.getInputPoint("start");var f=nearFacilityMap.getInputPoint("end");drivingRoute.search(c==null?g:c,f==null?a:f);},getWalkingRouteLines:function(g,a){var e=this;if(g==null||a==null||g==""||a==""){$("#map_search_condition_tips").removeClass("dn");$("#map_search_keyword_results").addClass("dn");return;}else{$("#map_search_condition_tips").addClass("dn");}var d=null;var b=null;linesWalkingRoute=new BMap.WalkingRoute(_map,{renderOptions:{map:_map},onSearchComplete:function(h){if(!e.lines){e.lines=[];}if(linesWalkingRoute.getStatus()==BMAP_STATUS_SUCCESS){if(h.getNumPlans()<=0){$("#map_search_loading").addClass("dn");$("#map_search_noresult").removeClass("dn");return;}d=h.getStart();b=h.getEnd();var j="";for(var i=0;i<h.getNumPlans();i++){var l=h.getPlan(i);var k={};k.plan=l;k.start=g;k.end=a;k.startPoint=h.getStart();k.endPoint=h.getEnd();k.duration=l.getDuration();k.distance=l.getDistance();e.lines[i]=k;j+='<li key="item" index="'+i+'" '+(i==0?' class="cur">':"");j+='<p class="top clearfix">';j+="<span>"+l.getDuration()+"</span>";j+='<em class="divider"></em>';j+="<span>"+l.getDistance()+"</span>";j+="</p>";j+="</li>";}e.drawWalkingRoute(e.lines[0]);$("#map_search_keyword_results").addClass("dn");$("#map_search_condition_results_walking").removeClass("dn");$("#map_search_condition_results_walking").html("<ul>"+j+"</ul>");$("#map_search_condition_results_walking").find("li[key=item]").on("click",function(){var m=$(this).attr("index");$(this).addClass("cur").siblings().removeClass("cur");nearFacilityMap.getWalkingRoutePlan(e.lines[m],_map.getZoom(),_map.getCenter());});}else{$("#map_search_noresult").removeClass("dn");}$("#map_search_loading").addClass("dn");},onPolylinesSet:function(h){linesWalkingRoute.clearResults();}});var c=nearFacilityMap.getInputPoint("start");var f=nearFacilityMap.getInputPoint("end");linesWalkingRoute.search(c==null?g:c,f==null?a:f);},getTransitRouteLines:function(g,a){var e=this;if(g==null||a==null||g==""||a==""){$("#map_search_condition_tips").removeClass("dn");$("#map_search_keyword_results").addClass("dn");return;}else{$("#map_search_condition_tips").addClass("dn");}var c=function(t){$("#map_search_keyword_results").addClass("dn");if(!e.lines){e.lines=[];}if(linesTransitRoute.getStatus()==BMAP_STATUS_SUCCESS){if(t.getNumPlans()<=0){$("#map_search_loading").addClass("dn");$("#map_search_noresult").removeClass("dn");return;}var n="";for(var l=0;l<t.getNumPlans();l++){var p=t.getPlan(l);var h={};h.plan=p;h.start=g;h.end=a;h.startPoint=t.getStart();h.endPoint=t.getEnd();var k=0;for(var j=0;j<p.getNumRoutes();j++){var q=p.getRoute(j);k+=q.getDistance(false);}h.walkDistance=k;var o="";for(j=0;j<p.getNumLines();j++){var s=p.getLine(j);var m=s.title;if(j!=0){o+=",";}o+=(m.substring(0,m.indexOf("(")));}h.lineStr=o;h.duration=t.getPlan(l).getDuration();h.distance=t.getPlan(l).getDistance();h.description=t.getPlan(l).getDescription(false);e.lines[l]=h;n+='<li key="item" index="'+l+'" '+(l==0?' class="cur">':"");n+='<p class="top clearfix">';var r=h.lineStr.split(",");for(var j=0;j<r.length;j++){if(j!=0){n+='<em class="arrow-symbol">→</em>';}n+="<span>"+r[j]+"</span>";}n+="</p>";n+='<p class="bottom clearfix">';n+="<span>"+h.duration+"</span>";n+='<em class="vertical-line"></em>';n+="<span>"+h.distance+"</span>";n+='<em class="vertical-line"></em>';n+="<span>步行约"+h.walkDistance+"米</span>";n+="</p>";n+="</li>";}$("#map_search_condition_results_transit").removeClass("dn");e.drawTransitRoute(e.lines[0]);$("#map_search_condition_results_transit").html("<ul>"+n+"</ul>");$("#map_search_condition_results_transit").find("li[key=item]").on("click",function(){var i=$(this).attr("index");$(this).addClass("cur").siblings().removeClass("cur");nearFacilityMap.getTransitRoutePlan(e.lines[i],_map.getZoom(),_map.getCenter());});}else{$("#map_search_noresult").removeClass("dn");}$("#map_search_loading").addClass("dn");};var b=function(h){linesTransitRoute.clearResults();};linesTransitRoute=new BMap.TransitRoute(_map,{renderOptions:{map:_map},onSearchComplete:c,onPolylinesSet:b});var d=nearFacilityMap.getInputPoint("start");var f=nearFacilityMap.getInputPoint("end");linesTransitRoute.search(d==null?g:d,f==null?a:f);},getInputPoint:function(a){var b=$("#"+a).attr("lng");var c=$("#"+a).attr("lat");if(b&&c){if(b!=""&&c!=""){return new BMap.Point(b,c);}}return null;},drawDrivingRoute:function(f){currDrawLineOnMap=f;var e=f.plan;for(var b=0;b<e.getNumRoutes();b++){var c=e.getRoute(b);_map.addOverlay(new BMap.Polyline(c.getPath()));}var a=new BMapLib.RichMarker('<p divType="poiMarker" class="starting-point"><span class="data">起</span><i class="shadow"></i></p>',f.startPoint.point);_map.addOverlay(a);var d=new BMapLib.RichMarker('<p divType="poiMarker" class="terminal-point"><span class="data">终</span><i class="shadow"></i></p>',f.endPoint.point);_map.addOverlay(d);$("#mapDiv").find('p[divType="poiMarker"]').parent().css("background","none");},drawWalkingRoute:function(f){currDrawLineOnMap=f;var e=f.plan;for(var c=0;c<e.getNumRoutes();c++){var a=e.getRoute(c);if(a.getDistance(false)>0){_map.addOverlay(new BMap.Polyline(a.getPath()));}}var b=new BMapLib.RichMarker('<p divType="poiMarker" class="starting-point"><span class="data">起</span><i class="shadow"></i></p>',f.startPoint.point);_map.addOverlay(b);var d=new BMapLib.RichMarker('<p divType="poiMarker" class="terminal-point"><span class="data">终</span><i class="shadow"></i></p>',f.endPoint.point);_map.addOverlay(d);$("#mapDiv").find('p[divType="poiMarker"]').parent().css("background","none");},drawTransitRoute:function(b){currDrawLineOnMap=b;var g=b.plan;for(var c=0;c<g.getNumRoutes();c++){var h=g.getRoute(c);if(h.getDistance(false)>0){_map.addOverlay(new BMap.Polyline(h.getPath(),{strokeColor:"green",strokeWeight:"5",strokeStyle:"dashed"}));}}for(c=0;c<g.getNumLines();c++){var j=g.getLine(c);if(j.type==BMAP_LINE_TYPE_SUBWAY){var a=new BMapLib.RichMarker('<p divType="poiMarker" title='+j.getGetOnStop().title+' class="traffic-tools-subway"></p>',j.getPath()[0]);_map.addOverlay(a);var d=new BMapLib.RichMarker('<p divType="poiMarker" title='+j.getGetOffStop().title+' class="traffic-tools-subway"></p>',j.getPath()[j.getPath().length-1]);_map.addOverlay(d);}else{var a=new BMapLib.RichMarker('<p divType="poiMarker" title='+j.getGetOnStop().title+' class="traffic-tools-bus" ></p>',j.getPath()[0]);_map.addOverlay(a);var d=new BMapLib.RichMarker('<p divType="poiMarker" title='+j.getGetOffStop().title+' class="traffic-tools-bus" ></p>',j.getPath()[j.getPath().length-1]);_map.addOverlay(d);}_map.addOverlay(new BMap.Polyline(j.getPath()));}var e=new BMapLib.RichMarker('<p divType="poiMarker" class="starting-point"><span class="data">起</span><i class="shadow"></i></p>',b.startPoint.point);_map.addOverlay(e);var f=new BMapLib.RichMarker('<p divType="poiMarker" class="terminal-point"><span class="data">终</span><i class="shadow"></i></p>',b.endPoint.point);_map.addOverlay(f);$("#mapDiv").find('p[divType="poiMarker"]').parent().css("background","none");},getDrivingRoutePlan:function(c,k,a){var f=this;f.searchLine();_map.setZoom(k);_map.setCenter(a);$("#map_search_condition").addClass("dn");f.drawDrivingRoute(c);var e="";e+='<div class="course-searching-results">';e+="<ul>";e+="<li>";e+='<i key="back" class="back"></i>';e+='<p class="top clearfix">';e+="<span>"+c.duration+"</span>";e+='<em class="divider"></em>';e+="<span>"+c.distance+"</span>";e+="</p>";e+="</li>";e+="</ul>";e+="</div>";e+='<div class="course-steps js-course-steps">';e+="<ul>";e+='<li class="start"><em class="circle"><i></i></em>起点 - '+c.start+"</li>";var g=c.plan;for(var d=0;d<g.getNumRoutes();d++){var h=g.getRoute(d);for(var b=0;b<h.getNumSteps();b++){e+="<li>"+h.getStep(b).getDescription(false)+"</li>";}}e+='<li class="end"><em class="circle"><i></i></em>终点 - '+c.end+"</li>";e+="</ul>";e+="</div>";$("#map_search_plans_driving").html(e);$("#map_search_plans_driving").removeClass("dn");},getWalkingRoutePlan:function(c,k,a){var f=this;f.searchLine();_map.setZoom(k);_map.setCenter(a);$("#map_search_condition").addClass("dn");f.drawWalkingRoute(c);var e="";e+='<div class="course-searching-results">';e+="<ul>";e+="<li>";e+='<i key="back" class="back"></i>';e+='<p class="top clearfix">';e+="<span>"+c.duration+"</span>";e+='<em class="divider"></em>';e+="<span>"+c.distance+"</span>";e+="</p>";e+="</li>";e+="</ul>";e+="</div>";e+='<div class="course-steps js-course-steps">';e+="<ul>";e+='<li class="start"><em class="circle"><i></i></em>起点 - '+c.start+"</li>";var g=c.plan;for(var d=0;d<g.getNumRoutes();d++){var h=g.getRoute(d);for(var b=0;b<h.getNumSteps();b++){e+="<li>"+h.getStep(b).getDescription(false)+"</li>";}}e+='<li class="end"><em class="circle"><i></i></em>终点 - '+c.end+"</li>";e+="</ul>";e+="</div>";$("#map_search_plans_walking").html(e);$("#map_search_plans_walking").removeClass("dn");},getTransitRoutePlan:function(f,c,u){var w=this;w.searchLine();_map.setZoom(c);_map.setCenter(u);$("#map_search_condition").addClass("dn");w.drawTransitRoute(f);var k="";k+='<div class="course-searching-results">';k+="<ul>";k+="<li>";k+='<i key="back" class="back"></i>';k+='<p class="top clearfix">';var l=f.lineStr.split(",");for(var p=0;p<l.length;p++){if(p!=0){k+='<em class="arrow-symbol">→</em>';}k+="<span>"+l[p]+"</span>";}k+="</p>";k+='<p class="bottom clearfix">';k+="<span>"+f.duration+"</span>";k+='<em class="vertical-line"></em>';k+="<span>"+f.distance+"</span>";k+='<em class="vertical-line"></em>';k+="<span>步行约"+f.walkDistance+"米</span>";k+="</p>";k+="</li>";k+="</ul>";k+="</div>";k+='<div class="course-steps js-course-steps">';k+="<ul>";k+='<li class="start"><em class="circle"><i></i></em>起点 - '+f.start+"</li>";var n=f.description;var y=n.split("步行");for(var p=0;p<y.length;p++){var v=y[p];if(!v||v=="null"||v==""){continue;}var x=("步行"+v).split("乘坐");for(var o=0;o<x.length;o++){var s=x[o];if(!s||s=="null"||s==""||s=="步行"){continue;}if(s.indexOf("步行")==-1){var m="乘坐"+s;var r=m.split("，");for(var g=0;g<r.length;g++){if(r[g].indexOf("乘坐")!=-1){m=m.replace(r[g].split("乘坐")[1],"<span>"+r[g].split("乘坐")[1]+"</span>");}if(r[g].indexOf("到达")!=-1){m=m.replace(r[g].split("到达")[1],"<span>"+r[g].split("到达")[1]+"</span>");}}k+=('<li class="by-bus"><em class="ico"><i></i></em>'+m+"</li>");}else{var m=s;var r=m.split("，");for(var g=0;g<r.length;g++){if(r[g].indexOf("步行")!=-1){m=m.replace(r[g].split("步行")[1],"<span>"+r[g].split("步行")[1]+"</span>");}if(r[g].indexOf("到达")!=-1){m=m.replace(r[g].split("到达")[1],"<span>"+r[g].split("到达")[1]+"</span>");}}k+=('<li class="walking"><em class="ico"><i></i></em>'+m+"</li>");}}}k+='<li class="end"><em class="circle"><i></i></em>终点 - '+f.end+"</li>";k+="</ul>";k+="</div>";$("#map_search_plans_transit").html(k);$("#map_search_plans_transit").removeClass("dn");var e=$("#map_search_plans_transit .course-searching-results li .top");var d=$("#map_search_plans_transit .course-searching-results li > p");var q=e.height();if(q<=18){e.css("padding-bottom","6px");d.css("line-height","18px");}else{e.css("padding-bottom",0);d.css("line-height","16px");}},addAccessRecord:function(a){try{$.ajax({url:ctx+"/map/stat",type:"post",data:{type:"detail",action:a,context:"",url:"",s:new Date().getTime()},success:function(c){}});}catch(b){}}};$("body").on("click",".map-surrounding-label p",function(){var a=$(this).index();$(this).addClass("cur").siblings().removeClass("cur");if(a=="0"){$("#msl").removeClass("dn");$("#msc").addClass("dn");$("#mapFuncsTbs").removeClass("dn");nearFacilityMap.searchPOI();}else{$("#msl").addClass("dn");$("#msc").removeClass("dn");$("#mapFuncsTbs").addClass("dn");nearFacilityMap.searchLine();if(start==null||end==null||start==""||end==""){return;}if(nearFacilityMap.startSearchFlag&&nearFacilityMap.endSearchFlag&&currDrawLineOnMap){var b=$("#courseChoose p.cur").attr("data-type");if(b=="bus"){nearFacilityMap.drawTransitRoute(currDrawLineOnMap);}else{if(b=="walking"){nearFacilityMap.drawWalkingRoute(currDrawLineOnMap);}else{if(b=="driving"){nearFacilityMap.drawDrivingRoute(currDrawLineOnMap);}}}}}});$("body").on("click","#courseChoose p",function(){var b=$(this).position().left;var c=$(this).outerWidth();var d=b+c/2-$(this).siblings(".sliding-arrow").width()/2+20;var a=$(this).data("type");$(this).addClass("cur").siblings().removeClass("cur");$(this).siblings(".sliding-arrow").animate({"left":d},{easing:"easeInOutQuad",duration:300});showOwnResults(a);});function showOwnResults(b){$("#map_search_condition_results_transit").addClass("dn");$("#map_search_condition_results_walking").addClass("dn");$("#map_search_condition_results_driving").addClass("dn");$("#map_search_noresult").addClass("dn");var c=$("#start").val();var a=$("#end").val();if(c==null||a==null||c==""||a==""){return;}if(nearFacilityMap.startSearchFlag&&nearFacilityMap.endSearchFlag){nearFacilityMap.getRouteLines();}else{}}$("body").on("click","#toggleSwitch",function(){var h=$("#start");var e=$("#end");var d=$.trim(h.val());var c=$.trim(e.val());if(d!=""&&c!=""){h.val(c);e.val(d);var g=h.attr("lng");var b=h.attr("lat");var f=e.attr("lng");var a=e.attr("lat");h.attr("lng",f?f:"");h.attr("lat",a?a:"");e.attr("lng",g?g:"");e.attr("lat",b?b:"");nearFacilityMap.searchLine();nearFacilityMap.drawLine();}if(d==""&&c!=""){h.val(c).siblings(".lf-label").hide();e.val("").focus().siblings(".lf-label").show();}if(d!==""&&c==""){h.val("").focus().siblings(".lf-label").show();e.val(d).siblings(".lf-label").hide();}});$("#start").keyup("click",function(c){$("#map_search_condition_results_transit").addClass("dn");$("#map_search_condition_results_walking").addClass("dn");$("#map_search_condition_results_driving").addClass("dn");$("#map_search_keyword_historys").addClass("dn");$("#map_search_condition_tips").addClass("dn");nearFacilityMap.startSearchFlag=false;if($("#start").val()==""){hideSearchResults();nearFacilityMap.getHistoryKeywords("start");$("#map_search_keyword_historys").removeClass("dn");return;}var b=c||window.event;if(b.stopPropagation){b.stopPropagation();}else{if(window.event){window.event.cancelBubble=true;}}var a=this;if(a._timeout){clearTimeout(a._timeout);}a._timeout=setTimeout(function(){nearFacilityMap.getKeywords("start");if($("#start").val()==""){hideSearchResults();nearFacilityMap.getHistoryKeywords("start");$("#map_search_keyword_historys").removeClass("dn");}},500);});$("#end").keyup("click",function(d){$("#map_search_condition_results_transit").addClass("dn");$("#map_search_condition_results_walking").addClass("dn");$("#map_search_condition_results_driving").addClass("dn");$("#map_search_keyword_historys").addClass("dn");$("#map_search_condition_tips").addClass("dn");var c=this.value;nearFacilityMap.endSearchFlag=false;if(c==$(this).attr("defalutText")){nearFacilityMap.endSearchFlag=true;}if($("#end").val()==""){hideSearchResults();nearFacilityMap.getHistoryKeywords("end");$("#map_search_keyword_historys").removeClass("dn");return;}var b=d||window.event;if(b.stopPropagation){b.stopPropagation();}else{if(window.event){window.event.cancelBubble=true;}}var a=this;if(a._timeout){clearTimeout(a._timeout);}a._timeout=setTimeout(function(){nearFacilityMap.getKeywords("end");if($("#end").val()==""){hideSearchResults();nearFacilityMap.getHistoryKeywords("end");$("#map_search_keyword_historys").removeClass("dn");}},500);});function hideSearchResults(){$("#map_search_condition_results_transit").addClass("dn");$("#map_search_condition_results_walking").addClass("dn");$("#map_search_condition_results_driving").addClass("dn");$("#map_search_condition_tips").addClass("dn");$("#map_search_keyword_results").addClass("dn");$("#map_search_keyword_historys").addClass("dn");$("#map_search_plans_transit").addClass("dn");$("#map_search_plans_driving").addClass("dn");$("#map_search_plans_walking").addClass("dn");$("#map_search_noresult").addClass("dn");}$("body").on("click","#start",function(c){var b=this.value;if(b==null||b==""){hideSearchResults();$("#map_search_keyword_historys").removeClass("dn");nearFacilityMap.getHistoryKeywords("start");}var a=c||window.event;if(a.stopPropagation){a.stopPropagation();}else{if(window.event){window.event.cancelBubble=true;}}});$("body").on("click","#end",function(c){var b=this.value;if(b==null||b==""){hideSearchResults();$("#map_search_keyword_historys").removeClass("dn");nearFacilityMap.getHistoryKeywords("end");}var a=c||window.event;if(a.stopPropagation){a.stopPropagation();}else{if(window.event){window.event.cancelBubble=true;}}});$("body").on("click","[key=back]",function(){$("#map_search_plans_transit").addClass("dn");$("#map_search_plans_walking").addClass("dn");$("#map_search_plans_driving").addClass("dn");$("#map_search_condition").removeClass("dn");});$("body").on("click",function(b){$("#map_search_keyword_results").addClass("dn");$("#map_search_keyword_historys").addClass("dn");var c=$("#start").val();var a=$("#end").val();if(c!==""&&a!==""){if(!nearFacilityMap.startSearchFlag||!nearFacilityMap.endSearchFlag){$("#map_search_condition_tips").removeClass("dn");}}});$("body").on("click","#map_search_condition_results_transit li",function(){if(nearFacilityMap.fullScreen){$(".js-course-steps").css({"height":$(window).height()-200-85-39-67-2});}});$("body").on("click","#map_search_condition_results_driving li",function(){if(nearFacilityMap.fullScreen){$(".js-course-steps").css({"height":$(window).height()-200-85-39-67-2});}});$("body").on("click","#map_search_condition_results_walking li",function(){if(nearFacilityMap.fullScreen){$(".js-course-steps").css({"height":$(window).height()-200-85-39-67-2});}});$(function(){if(typeof(pageStyle)!="undefined"&&pageStyle=="new"){$("#msb,#mapDiv").css({"width":463,"height":370});}if(typeof(houseCompare)=="undefined"||!houseCompare){nearFacilityMap.init();nearFacilityMap.initPanorama();}});